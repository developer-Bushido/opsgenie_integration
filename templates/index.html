<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>График дежурств</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
<div class="container">
    <h2 class="text-center my-4">График дежурств</h2>

    <!-- Таблица с дежурными -->
    <table class="table table-striped table-bordered text-center mb-4" id="summaryTable">
        <thead class="table-dark">
            <tr>
                <th>Дежурный</th>
                <th>Рабочие дни</th>
                <th>Нерабочие дни</th>
            </tr>
        </thead>
        <tbody>
            <!-- Данные будут загружаться динамически -->
        </tbody>
    </table>

    <!-- Календарь FullCalendar -->
    <div id="calendar"></div>
</div>

<!-- FullCalendar и Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Инициализация календаря и подгрузка событий -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarElement = document.getElementById('calendar');
        const summaryTableBody = document.getElementById('summaryTable').querySelector('tbody');

        let dayTypes = {}; // Глобальная переменная для хранения типов дней

        const calendar = new FullCalendar.Calendar(calendarElement, {
            initialView: 'dayGridMonth',
            locale: 'ru',
            firstDay: 1,  // Начало недели с понедельника
            headerToolbar: {
                left: 'prev,next',
                center: 'title',
                right: 'today'
            },
            buttonText: {
                today: 'Сегодня',
                month: 'Месяц',
                week: 'Неделя',
                day: 'День'
            },
            dayCellDidMount: function(info) {
                const dateStr = info.date.toISOString().split('T')[0];
                const dayType = dayTypes[dateStr];

                if (dayType === 'Weekend') {
                    info.el.classList.add('weekend');
                } else if (dayType === 'Weekday') {
                    // Ничего не делаем, оставляем стандартный фон
                } else if (dayType) {
                    // Это праздник
                    info.el.classList.add('holiday');

                    // Устанавливаем атрибут title для подсказки
                    info.el.setAttribute('title', dayType);
                }
            },
            events: function(info, successCallback, failureCallback) {
                const startDate = new Date(info.start);
                const endDate = new Date(info.end);
                const midTime = (startDate.getTime() + endDate.getTime()) / 2;
                const midDate = new Date(midTime);
                const year = midDate.getFullYear();
                const month = midDate.getMonth() + 1;

                fetch(`/get_events?year=${year}&month=${month}`)
                    .then(response => response.json())
                    .then(data => {
                        dayTypes = data.day_types; // Сохраняем day_types для использования в dayCellDidMount
                        successCallback(data.events);
                        updateSummaryTable(data.summary);
                    })
                    .catch(error => failureCallback(error));
            }
        });

        calendar.render();

        function updateSummaryTable(summaryData) {
            summaryTableBody.innerHTML = ''; // Очищаем таблицу перед обновлением
            summaryData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.user}</td>
                    <td>${item.workdays_count}</td>
                    <td>${item.holidays_weekends_count}</td>
                `;
                summaryTableBody.appendChild(row);
            });
        }
    });
</script>
</body>
</html>